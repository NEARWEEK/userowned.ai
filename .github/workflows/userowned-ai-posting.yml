# UserOwned.ai Automated Posting Workflow
# Uses the working run-template.js script for reliable posting
name: UserOwned.ai Intelligence Posting

on:
  schedule:
    # Test posting - 15:25 CET (14:25 UTC)
    - cron: '25 14 * * *'
  workflow_dispatch:
    inputs:
      template_type:
        description: 'Template to execute'
        required: true
        default: 'daily-minimal'
        type: choice
        options:
          - daily-minimal
          - daily-detailed
          - daily-visual
          - daily-narrative
          - daily-technical
          - daily-competitive
          - daily-investor
          - daily-ecosystem

jobs:
  post-intelligence:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository  
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
        
    - name: Determine template type
      id: template
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          # A/B Testing: Cycle through different formats daily
          DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday
          case $DAY_OF_WEEK in
            1) TEMPLATE_TYPE="daily-minimal" ;;      # Monday - Format A
            2) TEMPLATE_TYPE="daily-detailed" ;;     # Tuesday - Format B
            3) TEMPLATE_TYPE="daily-visual" ;;       # Wednesday - Format C
            4) TEMPLATE_TYPE="daily-narrative" ;;    # Thursday - Format D
            5) TEMPLATE_TYPE="daily-technical" ;;    # Friday - Format E
            6) TEMPLATE_TYPE="daily-competitive" ;;  # Saturday - Format F
            7) TEMPLATE_TYPE="daily-investor" ;;     # Sunday - Format G
            *) TEMPLATE_TYPE="daily-minimal" ;;      # Fallback
          esac
        else
          TEMPLATE_TYPE="${{ github.event.inputs.template_type }}"
        fi
        
        echo "template_type=$TEMPLATE_TYPE" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Selected template: $TEMPLATE_TYPE (A/B Testing Format)"
        
    - name: Run template and post to channels
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        ZAPIER_WEBHOOK_URL: ${{ secrets.ZAPIER_WEBHOOK_URL }}
      run: |
        echo "ðŸš€ UserOwned.ai Intelligence System"
        echo "ðŸ“‹ Template: ${{ steps.template.outputs.template_type }}"
        echo "â° Timestamp: $(date -u)"
        echo ""
        
        # Execute the working template script with posting enabled
        node src/scripts/run-template.js ${{ steps.template.outputs.template_type }} --post
        
    - name: Create execution summary
      run: |
        echo "## ðŸŽ¯ UserOwned.ai Intelligence Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Template**: ${{ steps.template.outputs.template_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Distribution Channels" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± Telegram: Posted to POOOL group" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¦ X/Twitter: Posted via Zapier webhook" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ GitHub: Issue created with detailed report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*UserOwned.ai Intelligence System*" >> $GITHUB_STEP_SUMMARY