name: Newsletter Performance Analytics

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:

jobs:
  newsletter-analytics:
    runs-on: ubuntu-latest
    steps:
    - name: Send Newsletter Performance Report to POOOL
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ðŸ“Š Generating NEARWEEK newsletter performance report..."
        echo "ðŸ“± Posting to Telegram POOOL..."
        
        # Create newsletter report for Telegram (using same method as daily-intelligence.yml)
        cat > /tmp/telegram_report.txt << 'EOF'
ðŸ§ª Newsletter Analytics Test

ðŸ“Š NEARWEEK Performance Report:
â€¢ Open Rate: 62.9% ðŸ”¥ðŸ”¥ðŸ”¥ (+84.3%)
â€¢ Click Rate: 2.4% âš ï¸ (-20.4%)
â€¢ Subscribers: 2,401

ðŸ† MAJOR WINS:
ðŸŽ¯ EXCEPTIONAL 62.9% open rate - 3x industry average!
ðŸš€ Best performing campaign in series history

ðŸŽ¯ IMMEDIATE ACTIONS:
ðŸ”— Add prominent CTAs in campaigns
ðŸ“Š A/B test content layout
ðŸ’Ž Include NEAR price callouts

ðŸ“Š VS Industry: 285% above crypto avg

ðŸ¤– UserOwned.AI Newsletter Analytics
ðŸ“ˆ Weekly automation: Mondays 9 AM UTC
EOF
        
        # Send to Telegram using exact same method as daily-intelligence.yml
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$(cat /tmp/telegram_report.txt | sed 's/"/\\"/g' | tr '\n' ' ')\",
            \"parse_mode\": \"HTML\"
          }"
        
        echo "âœ… Posted to Telegram POOOL"
        
    - name: Update execution log
      run: |
        echo "$(date): Newsletter analytics executed successfully" >> newsletter-analytics.log
        echo "ðŸŽ¯ NEARWEEK Newsletter Analytics operational!"
