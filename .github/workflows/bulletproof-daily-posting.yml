# ğŸš¨ EMERGENCY: Bulletproof UserOwned.ai Daily Posting
name: "ğŸ¤– Bulletproof UserOwned.ai Daily 10:05 CET"
on:
  schedule:
    - cron: '5 9 * * *'  # 10:05 CET (offset to avoid conflicts)
  workflow_dispatch:  # Allow manual testing

jobs:
  bulletproof-posting:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Explicit permissions
      actions: write
      issues: write
    
    steps:
    - name: ğŸ”§ Checkout Repository  
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Generate Daily Intelligence Content
      id: content
      run: |
        echo "ğŸ¤– Generating bulletproof daily content..."
        
        # Get current date in multiple formats
        REPORT_DATE=$(TZ='Europe/Berlin' date '+%Y-%m-%d')
        CET_TIME=$(TZ='Europe/Berlin' date '+%H:%M CET')
        UTC_TIME=$(date -u '+%H:%M UTC')
        
        # Mock ecosystem scores (enhance with real APIs later)
        NEAR_SCORE=85
        ICP_SCORE=72  
        TAO_SCORE=68
        DEFI_TVL=157
        COMBINED_STARS=7800
        
        # Create optimized X content (under 280 chars)
        X_CONTENT="ğŸ¤– UserOwned.ai Daily Intelligence $REPORT_DATE

ğŸ† AI x Crypto Rankings:
1. NEAR: $NEAR_SCORE/100 â­
2. ICP: $ICP_SCORE/100 ğŸ”¬
3. TAO: $TAO_SCORE/100 ğŸ§ 

ğŸ“Š $COMBINED_STARS GitHub stars
ğŸ’° \$${DEFI_TVL}B DeFi market
ğŸ“ˆ userowned.ai

#UserOwnedAI #NEAR #ICP #Bittensor #AI #DeFi"
        
        # Store content for multiple steps
        echo "X_CONTENT<<EOF" >> $GITHUB_ENV
        echo "$X_CONTENT" >> $GITHUB_ENV  
        echo "EOF" >> $GITHUB_ENV
        
        echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_ENV
        echo "CET_TIME=$CET_TIME" >> $GITHUB_ENV
        echo "UTC_TIME=$UTC_TIME" >> $GITHUB_ENV
        
        echo "âœ… Content generated: $REPORT_DATE at $CET_TIME"

    - name: ğŸ¦ Method 1 - Post via Zapier/Buffer (Primary)
      if: ${{ secrets.ZAPIER_WEBHOOK_URL }}
      continue-on-error: true
      run: |
        echo "ğŸ“¡ Posting via Zapier/Buffer (Method 1)..."
        
        RESPONSE=$(curl -w "%{http_code}" -s -o /tmp/zapier_response.txt \
          -X POST "${{ secrets.ZAPIER_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"text\": \"$X_CONTENT\",
            \"source\": \"userowned-ai-bulletproof\", 
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"method\": \"zapier-buffer\",
            \"account\": \"userownedai\"
          }")
          
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… SUCCESS: Posted via Zapier/Buffer"
          echo "ZAPIER_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âŒ FAILED: Zapier/Buffer returned $RESPONSE"
          cat /tmp/zapier_response.txt
          echo "ZAPIER_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: ğŸ“± Method 2 - Post via Telegram (Backup)
      if: ${{ secrets.TELEGRAM_BOT_TOKEN && secrets.TELEGRAM_CHAT_ID }}
      continue-on-error: true
      run: |
        echo "ğŸ“± Posting via Telegram (Method 2)..."
        
        # Create Telegram version
        TELEGRAM_CONTENT="ğŸ¤– User-Owned AI Daily Update $REPORT_DATE

ğŸ† AI Ecosystem Scores:
1. NEAR: 85/100 â­
2. ICP: 72/100 ğŸ”¬ 
3. TAO: 68/100 ğŸ§ 

ğŸ’° Market: \$157B DeFi Total
ğŸ“ˆ Full analysis: userowned.ai
ğŸ”— @userownedai | @NEARWEEK

â° Posted at $CET_TIME"
        
        RESPONSE=$(curl -w "%{http_code}" -s -o /tmp/telegram_response.txt \
          -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$TELEGRAM_CONTENT\",
            \"parse_mode\": \"HTML\"
          }")
          
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… SUCCESS: Posted via Telegram"
          echo "TELEGRAM_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âŒ FAILED: Telegram returned $RESPONSE"
          cat /tmp/telegram_response.txt  
          echo "TELEGRAM_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: ğŸ“ Method 3 - Create GitHub Issue (Monitoring)
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          const today = process.env.REPORT_DATE;
          const cetTime = process.env.CET_TIME;
          const zapierSuccess = process.env.ZAPIER_SUCCESS === 'true';
          const telegramSuccess = process.env.TELEGRAM_SUCCESS === 'true';
          
          const statusEmoji = zapierSuccess ? 'âœ…' : 'âŒ';
          const telegramEmoji = telegramSuccess ? 'âœ…' : 'âŒ';
          
          const title = `ğŸ¤– Daily Intelligence ${today} - Posted at ${cetTime}`;
          const body = `## Daily Intelligence Report ${today}

### Posting Status
- ${statusEmoji} **X via Zapier/Buffer**: ${zapierSuccess ? 'SUCCESS' : 'FAILED'}
- ${telegramEmoji} **Telegram**: ${telegramSuccess ? 'SUCCESS' : 'FAILED'}
- âœ… **GitHub Issue**: SUCCESS (this issue)

### Content Posted
\`\`\`
${process.env.X_CONTENT}
\`\`\`

### Metrics
- **Time**: ${cetTime}
- **Method**: Bulletproof multi-channel posting
- **Reliability**: ${zapierSuccess || telegramSuccess ? 'âœ… At least one channel succeeded' : 'âŒ All channels failed'}

### Next Steps
${zapierSuccess ? 'âœ… Daily posting working correctly' : 'âš ï¸ Check Zapier webhook configuration'}

---
*Automated by UserOwned.ai Bulletproof Posting System*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['daily-intelligence', 'automated-posting', 'status-report']
          });

    - name: ğŸ”„ Keep Repository Active (Prevent Workflow Disabling)
      run: |
        echo "ğŸ”„ Keeping repository active to prevent workflow disabling..."
        
        # Create/update activity file to prevent GitHub from disabling workflows
        mkdir -p .github/activity
        echo "Last activity: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > .github/activity/last-run.txt
        echo "Workflow: bulletproof-daily-posting" >> .github/activity/last-run.txt
        echo "Status: ${ZAPIER_SUCCESS:-false}" >> .github/activity/last-run.txt
        
        # Commit if there are changes
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add .github/activity/last-run.txt
          git commit -m "ğŸ¤– Keep repo active - Daily posting $(date '+%Y-%m-%d')"
          git push
          echo "âœ… Repository activity updated"
        fi

    - name: ğŸ“Š Final Status Report
      run: |
        echo "ğŸ¯ UserOwned.ai Bulletproof Daily Posting Complete!"
        echo "=================================================="
        echo ""
        echo "ğŸ“… Date: $REPORT_DATE"
        echo "â° Time: $CET_TIME ($UTC_TIME)"
        echo "ğŸ¦ X via Zapier/Buffer: ${ZAPIER_SUCCESS:-false}"
        echo "ğŸ“± Telegram: ${TELEGRAM_SUCCESS:-false}" 
        echo "ğŸ“ GitHub Issue: âœ… true"
        echo "ğŸ”„ Repository Activity: âœ… true"
        echo ""
        echo "ğŸš€ Next run: Tomorrow at 10:05 CET"
        echo "ğŸ“ˆ X Account: @userownedai"
        echo "ğŸ“Š Status: $([ "${ZAPIER_SUCCESS:-false}" = "true" ] && echo "âœ… OPERATIONAL" || echo "âš ï¸ DEGRADED")"
        echo ""
        echo "Content posted:"
        echo "=============="
        echo "$X_CONTENT"
        echo "=============="

    - name: ğŸš¨ Emergency Alert (If All Methods Failed)
      if: ${{ env.ZAPIER_SUCCESS != 'true' && env.TELEGRAM_SUCCESS != 'true' }}
      run: |
        echo "ğŸš¨ EMERGENCY: All posting methods failed!"
        echo "This requires immediate manual intervention."
        echo ""
        echo "Manual posting commands:"
        echo "========================"
        echo "X Content to post manually:"
        echo "$X_CONTENT"
        echo ""
        echo "Telegram content:"
        echo "User-Owned AI Daily Update $REPORT_DATE - MANUAL POSTING REQUIRED"
        echo ""
        exit 1  # Fail the workflow to trigger alerts
